services:
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: openclaw-nginx
    ports:
      - "80:80"   # worker_0
      - "81:81"   # worker_1
    env_file:
      - nginx.env
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    command:
      - /bin/sh
      - -c
      - printf '%s:%s\n' "$$PROXY_BASIC_AUTH_USER" "$$(openssl passwd -apr1 "$$PROXY_BASIC_AUTH_PASS")" > /etc/nginx/.htpasswd && exec nginx -g 'daemon off;'

  worker_0:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: operator-worker_0
    working_dir: /app
    stdin_open: true
    tty: true
    env_file:
      - ./agents/worker_0/.env
    environment:
      OPENCLAW_PROXY_HOST: nginx
      OPENCLAW_DISABLE_BONJOUR: "1"
    volumes:
      - ./agents/worker_0/files:/app/files
      - ./agents/worker_0/config.js:/app/config.js:ro
    depends_on:
      - nginx

  worker_1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: operator-worker_1
    working_dir: /app
    stdin_open: true
    tty: true
    env_file:
      - ./agents/worker_1/.env
    environment:
      OPENCLAW_PROXY_HOST: nginx
      OPENCLAW_DISABLE_BONJOUR: "1"
    volumes:
      - ./agents/worker_1/files:/app/files
      - ./agents/worker_1/config.js:/app/config.js:ro
    depends_on:
      - nginx
