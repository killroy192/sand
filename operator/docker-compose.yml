services:
  openclaw:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: openclaw-operator
    working_dir: /app
    stdin_open: true
    tty: true
    env_file:
      - openclaw.env
    environment:
      OPENCLAW_BOOTSTRAP: "1"
      OPENCLAW_ACCEPT_RISK: "1"
      OPENCLAW_GATEWAY_PORT: "18789"
      OPENCLAW_GATEWAY_BIND: "lan"
      OPENCLAW_BROWSER_ENABLED: "0"
      OPENCLAW_TRUSTED_PROXY_IPS: "172.28.0.2"
    volumes:
      - ./files:/app/files
    networks:
      operator_net:
        ipv4_address: 172.28.0.3

  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: openclaw-nginx
    depends_on:
      - openclaw
    ports:
      - "18789:80"
    env_file:
      - nginx.env
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    command:
      - /bin/sh
      - -c
      - printf '%s:%s\n' "$$PROXY_BASIC_AUTH_USER" "$$(openssl passwd -apr1 "$$PROXY_BASIC_AUTH_PASS")" > /etc/nginx/.htpasswd && exec nginx -g 'daemon off;'
    networks:
      operator_net:
        ipv4_address: 172.28.0.2

networks:
  operator_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/24
